{% set cpu_topology = ansible_local["topology"]["cpu_topology"] -%}
{% set gpu_topology = ansible_local["topology"]["gpu_topology"] -%}
{% if slurm_enable_nvml_autodetect %}
# Automatically validate GPU configuration using NVML
AutoDetect=nvml

{% endif %}
# Configure GPU GRES with CPU affinity
{% for affinity in gpu_topology %}
Name=gpu File=/dev/nvidia{{ loop.index0 }} CPUs={{ affinity }}
{% endfor %}

{% if slurm_enable_mps %}
# Configure NVIDIA Multi-Process Service (MPS) via Slurm GRES
{% for affinity in gpu_topology %}
Name=mps Count={{ slurm_mps_per_gpu }} File=/dev/nvidia{{ loop.index0 }}
{% endfor %}
{% endif %}
